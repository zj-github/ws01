package cn.innohub.crawler.conf;

import java.util.ArrayList;
import java.util.List;

import org.dom4j.Document;
import org.dom4j.Element;
import org.dom4j.Node;

import cn.innohub.crawler.beans.ExtractField;
import cn.innohub.crawler.beans.ExtractRule;
import cn.innohub.crawler.common.FileNameConstant;
import cn.innohub.crawler.core.Context;
import cn.innohub.crawler.utils.Dom4JUtil;
import cn.innohub.crawler.utils.Path;

/**
 * @ClassName: CrawlConf 
 * @Description: 配置文件上下文 
 * @author zhangjie
 * @date 2016年1月4日 上午10:19:28 
 *
 */
public class FieldsExtractRegReader  {

	public void initConf() {
		Context.getInstance().getRuleMap().clear();//清空以前的内容
		String xmlFilePath = Path.getClassPath() + FileNameConstant.FIELDS_EXTRACT_REG_XML;
		this.loadFieldsExtractRegXml(xmlFilePath);
	}
	
	private  void loadFieldsExtractRegXml(String fieldsExtractRegXmlPath) {
		try {
			Document doc = Dom4JUtil.getDocument(fieldsExtractRegXmlPath);

			/** 1、读取host节点 */
			@SuppressWarnings("unchecked")
			List<Element> ruleNodeList = doc.selectNodes("/extract-rules/rule");
			for (Element rule : ruleNodeList) {
				ExtractRule extractRule = new ExtractRule();

				Node hostname = rule.selectSingleNode("hostname");
				Node clazz = rule.selectSingleNode("clazz");
				extractRule.setHostName(hostname.getText().trim());
				extractRule.setClazz(clazz.getText().trim());

				@SuppressWarnings("unchecked")
				List<Node> fields = rule.selectNodes("field");
				if (fields != null && fields.size() != 0) {
					List<ExtractField> extractFieldsNode = extractFieldsNode(fields);
					extractRule.setFields(extractFieldsNode);
				}
				Context.getInstance().addRule(hostname.getText().trim(), extractRule);
			}

		} catch (Exception e) {
			e.printStackTrace();
		}

	}

	/**
	 * 
	 * @Description: 抽取Field
	 * @author zhangjie
	 * @date 2016年1月4日 下午5:11:29
	 *
	 */
	private   List<ExtractField> extractFieldsNode(List<Node> fields) {
		List<ExtractField> extractFieldList = new ArrayList<ExtractField>();
		for (Node node : fields) {
			ExtractField extractField = new ExtractField();
			Node name = node.selectSingleNode("name");
			Node method = node.selectSingleNode("method");
			Node reg = node.selectSingleNode("reg");

			extractField.setMethod(method.getText().trim());
			extractField.setName(name.getText().trim());
			extractField.setReg(reg.getText().trim());

			extractFieldList.add(extractField);
		}
		return extractFieldList;
	}

}
